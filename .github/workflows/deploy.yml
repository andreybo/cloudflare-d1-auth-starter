name: CI/CD for Cloudflare

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ⬣ Lint
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: ⎔ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22.9.0

      - name: 📥 Install deps
        run: pnpm install

      - name: 🔬 Lint
        run: pnpm -r run lint || true 

  publish-client:
    name: 🚀 Publish Client
    if: ${{ github.ref == 'refs/heads/main' }}
    needs: [lint]
    runs-on: ubuntu-latest
    env:
      VITE_APP_NAME: ${{ secrets.VITE_APP_NAME }}
      VITE_APP_API_BASE_URL: ${{ secrets.VITE_APP_API_BASE_URL }}
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: ⎔ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22.9.0

      - name: 📥 Install deps
        working-directory: ./client
        run: pnpm install

      - name: ➕ Create .env file
        working-directory: ./client
        run: |
          echo "VITE_APP_NAME=${{ secrets.VITE_APP_NAME }}" >> .env
          echo "VITE_APP_API_BASE_URL=${{ secrets.VITE_APP_API_BASE_URL }}" >> .env

      - name: ⚙️ Build Client
        working-directory: ./client
        run: pnpm run build

      - name: 🚀 Deploy Client
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: <YOUR_CLIENT_PROJECT_NAME>
          directory: ./client/dist

  publish-server:
    name: 🚀 Publish Server
    if: ${{ github.ref == 'refs/heads/main' }}
    needs: [lint]
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_D1_TOKEN: ${{ secrets.CLOUDFLARE_D1_TOKEN }}
      CLOUDFLARE_DATABASE_ID: ${{ secrets.CLOUDFLARE_DATABASE_ID }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}
      NODE_ENV: production
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        name: Install pnpm
        with:
          version: 9
          run_install: false

      - name: ⎔ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22.9.0

      - name: 📥 Install deps
        working-directory: ./server
        run: pnpm install

      - name: ➕ Create .env file
        working-directory: ./server
        run: |
          echo "CLOUDFLARE_D1_TOKEN=${{ secrets.CLOUDFLARE_D1_TOKEN }}" >> .env
          echo "CLOUDFLARE_DATABASE_ID=${{ secrets.CLOUDFLARE_DATABASE_ID }}" >> .env
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "REFRESH_SECRET=${{ secrets.REFRESH_SECRET }}" >> .env
          echo "NODE_ENV=production" >> .env

      - name: ⚙️ Build Server
        working-directory: ./server
        run: pnpm run build

      - name: 🚀 Deploy Server
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          environment: production
          workingDirectory: server
